<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routine</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
            padding-bottom: 0;
            position: relative;
        }


        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .progress-container {
            margin-bottom: 30px;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .exercise-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .exercise-card.rest {
            background: #f0fdf4;
        }

        .section-badge {
            display: none;
        }

        .exercise-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }

        .set-info {
            color: #764ba2;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .timer-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .timer-display.rest {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 4px 20px rgba(72, 187, 120, 0.3);
        }

        .timer-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .timer-time {
            font-size: 36px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .reps-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            font-size: 24px;
            font-weight: 600;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .instructions {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .instructions p {
            color: #555;
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .feel-cue {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px 16px;
            margin-top: 15px;
            border-radius: 5px;
            color: #856404;
            font-style: italic;
        }

        .next-preview {
            background: #f8f9fa;
            padding: 14px 18px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 15px;
            color: #555;
            text-align: center;
            font-weight: 500;
        }

        .next-preview strong {
            color: #667eea;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .controls {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px 0 40px 0;
            margin-top: 30px;
            margin-left: -40px;
            margin-right: -40px;
            padding-left: 40px;
            padding-right: 40px;
            border-top: 1px solid #f0f0f0;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
            border-radius: 0 0 20px 20px;
        }

        .all-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .all-controls .btn {
            padding: 12px 16px;
            font-size: 18px;
            flex: 1;
            min-width: 0;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn {
            padding: 18px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            grid-column: 2;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e9ecef;
            color: #495057;
            flex: 1;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .btn-tertiary {
            background: #e9ecef;
            color: #495057;
            padding: 12px 20px;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            min-width: 120px;
        }

        .btn-tertiary:hover {
            background: #dee2e6;
        }

        @media (max-width: 600px) {
            .nav-controls {
                grid-template-columns: 1fr;
            }

            .btn-primary {
                grid-column: 1;
            }
        }

        .sound-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f8f9fa;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .sound-toggle:hover {
            background: #e9ecef;
            transform: scale(1.1);
        }

        .timeline-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #f8f9fa;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .timeline-toggle:hover {
            background: #e9ecef;
            transform: scale(1.1);
        }

        .timeline-panel {
            position: fixed;
            top: 0;
            left: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
            transition: left 0.3s ease;
            z-index: 999;
            overflow-y: auto;
            padding: 20px;
        }

        .timeline-panel.open {
            left: 0;
        }

        .timeline-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 998;
        }

        .timeline-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .timeline-header {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timeline-header-title {
            flex: 1;
        }

        .timeline-header-actions {
            display: flex;
            gap: 8px;
        }

        .timeline-btn {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .timeline-btn-edit {
            background: #667eea;
            color: white;
        }

        .timeline-btn-edit:hover {
            background: #5568d3;
        }

        .timeline-btn-reset {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e0e0e0;
        }

        .timeline-btn-reset:hover {
            background: #e9ecef;
        }

        .editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .editor-modal.open {
            display: flex;
        }

        .editor-container {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .editor-header {
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }

        .editor-header-actions {
            display: flex;
            gap: 10px;
        }

        .editor-textarea {
            flex: 1;
            margin: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            overflow-y: auto;
        }

        .editor-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .settings-container {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .settings-header {
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }

        .settings-content {
            padding: 20px;
            overflow-y: auto;
        }

        .setting-item {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: background 0.2s ease;
        }

        .setting-item:hover {
            background: #e9ecef;
        }

        .setting-label {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            cursor: pointer;
            user-select: none;
        }

        .setting-checkbox {
            margin-top: 2px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .setting-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .setting-text strong {
            color: #333;
            font-size: 16px;
        }

        .setting-text small {
            color: #6c757d;
            font-size: 13px;
            line-height: 1.4;
        }

        .settings-tip {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .settings-tip strong {
            display: block;
            color: #999;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .settings-tip-content {
            color: #999;
            font-size: 12px;
            font-weight: 500;
        }

        .settings-tip kbd {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px 6px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            font-size: 11px;
            color: #666;
        }

        .timeline-section {
            margin-bottom: 25px;
        }

        .timeline-section-title {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .timeline-exercise {
            padding: 10px 15px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            font-size: 14px;
            color: #555;
        }

        .timeline-exercise:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .timeline-exercise.current {
            background: #e7f3ff;
            border-left-color: #667eea;
            font-weight: 600;
            color: #333;
        }

        .timeline-exercise.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .timeline-exercise.rest {
            background: none;
            padding: 5px 15px;
            border-left: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #999;
            font-style: italic;
        }

        .timeline-exercise.rest::before {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, #48bb78, transparent);
        }

        .timeline-exercise.rest:hover {
            background: none;
            transform: translateX(0);
            color: #48bb78;
        }

        .timeline-exercise.rest.current {
            background: none;
            color: #48bb78;
            font-weight: 500;
        }

        .timeline-exercise.rest.current::before {
            background: linear-gradient(to right, #38a169, transparent);
        }

        .timeline-exercise-meta {
            font-size: 11px;
            color: #999;
            margin-top: 3px;
        }

        @media (max-width: 600px) {
            .timeline-panel {
                width: 90%;
                left: -90%;
            }
        }

        .completion-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .completion-screen h2 {
            font-size: 36px;
            color: #333;
            margin-bottom: 20px;
        }

        .completion-emoji {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .stats {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }

        .stat-item {
            margin: 15px 0;
            font-size: 18px;
            color: #555;
        }

        .stat-value {
            font-weight: 700;
            color: #667eea;
            font-size: 24px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 20px;
                padding-bottom: 0;
            }

            /* Compact header on mobile */
            .header {
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .header p {
                font-size: 13px;
            }

            /* Fix editor header buttons on mobile */
            .editor-header {
                padding: 15px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .editor-header h2 {
                font-size: 16px;
                flex: 1 0 100%;
                margin-bottom: 5px;
            }

            .editor-header-actions {
                gap: 6px;
                flex: 1 0 100%;
            }

            .editor-header-actions .btn {
                padding: 8px 10px !important;
                font-size: 11px !important;
                min-width: 0;
                flex: 1;
            }

            .editor-container {
                width: 95%;
                height: 90vh;
            }

            .settings-container {
                width: 95%;
            }

            .settings-header {
                padding: 15px;
            }

            /* Compact progress bar */
            .progress-container {
                margin-bottom: 20px;
            }

            .progress-text {
                font-size: 12px;
            }

            .progress-bar {
                height: 6px;
            }

            /* Compact exercise card */
            .exercise-card {
                padding: 20px;
                margin-bottom: 20px;
            }

            .section-badge {
                font-size: 11px;
                padding: 5px 12px;
            }

            .exercise-title {
                font-size: 20px;
            }

            .set-info {
                font-size: 12px;
            }

            /* Compact timer */
            .timer-display {
                padding: 20px;
                margin-bottom: 16px;
            }

            .timer-time {
                font-size: 36px;
            }

            /* Compact reps */
            .reps-display {
                padding: 18px;
                margin-bottom: 16px;
            }

            .reps-display span {
                font-size: 16px;
            }

            /* Instructions */
            .instructions p {
                font-size: 14px;
                line-height: 1.5;
            }

            .feel-cue {
                padding: 12px;
                font-size: 13px;
            }

            /* Reduce next preview margins on mobile */
            .next-preview {
                padding: 6px 12px 8px 12px;
                margin-top: 10px;
            }

            /* Sticky controls */
            .controls {
                margin-top: 20px;
                margin-left: -20px;
                margin-right: -20px;
                padding-left: 20px;
                padding-right: 20px;
                padding-top: 16px;
                padding-bottom: 20px;
            }

            .all-controls {
                gap: 8px;
            }

            .all-controls .btn {
                padding: 12px 10px;
                font-size: 13px;
                flex: 1;
                min-width: 0;
                height: 46px;
            }
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
        }

        /* Confirmation modal */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }

        .confirm-modal.show {
            display: flex;
        }

        .confirm-dialog {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .confirm-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2d3748;
        }

        .confirm-message {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .confirm-actions .btn {
            min-width: 80px;
        }

        .modal-close-btn {
            position: absolute;
            top: -10px;
            left: -10px;
            background: white;
            border: 2px solid #e0e0e0;
            font-size: 16px;
            color: #666;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            line-height: 1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-close-btn:hover {
            background: #f8f8f8;
            color: #333;
            border-color: #ccc;
            transform: scale(1.1);
        }

        .confirm-dialog {
            position: relative;
        }

        .editor-container {
            position: relative;
        }

        .settings-container {
            position: relative;
        }

        /* Info icon button */
        .info-icon-btn {
            background: #e9ecef;
            border: 1px solid #cbd5e0;
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            vertical-align: middle;
        }

        .info-icon-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.1);
        }

        /* Info modal */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }

        .info-modal.show {
            display: flex;
        }

        .info-dialog {
            background: white;
            border-radius: 12px;
            padding: 28px;
            max-width: 520px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .info-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #2d3748;
        }

        .info-message {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .info-message p {
            margin: 0 0 12px 0;
        }

        .info-message ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .info-message li {
            margin: 8px 0;
        }

        .info-message strong {
            color: #2d3748;
        }

        .info-code-block {
            position: relative;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .info-code-block code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 13px;
            color: #2d3748;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: block;
            line-height: 1.5;
        }

        .info-code-copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: white;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .info-code-copy-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .info-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .info-actions .btn {
            min-width: 100px;
        }
    </style>
</head>
<body>
    <div class="timeline-overlay" id="timelineOverlay"></div>

    <div class="timeline-panel" id="timelinePanel">
        <div class="timeline-header">
            <div class="timeline-header-title">Routine Timeline</div>
            <div class="timeline-header-actions">
                <button class="timeline-btn timeline-btn-edit" id="editConfigBtn" title="Edit routine configuration">✏️ Edit</button>
            </div>
        </div>
        <div id="timelineContent"></div>
    </div>

    <div class="editor-modal" id="editorModal">
        <div class="editor-container">
            <button class="modal-close-btn" id="editorCloseBtn" title="Close">×</button>
            <div class="editor-header">
                <h2>Edit Routine <button class="info-icon-btn" id="routineInfoBtn" title="How to create your own routine">?</button></h2>
                <div class="editor-header-actions">
                    <button class="btn btn-secondary" id="shareConfigBtn" style="padding: 8px 16px; font-size: 13px; white-space: nowrap;">🔗 Share</button>
                    <button class="btn btn-secondary" id="resetConfigBtn" style="padding: 8px 16px; font-size: 13px; white-space: nowrap;">↺ Reset</button>
                    <button class="btn btn-primary" id="editorSaveBtn" style="padding: 8px 16px; font-size: 13px; white-space: nowrap;">Save Changes</button>
                </div>
            </div>
            <textarea class="editor-textarea" id="editorTextarea" spellcheck="false"></textarea>
        </div>
    </div>

    <div class="editor-modal" id="settingsModal">
        <div class="settings-container">
            <button class="modal-close-btn" id="settingsCloseBtnX" title="Close">×</button>
            <div class="settings-header">
                <h2>Settings</h2>
                <button class="btn btn-primary" id="settingsCloseBtn" style="padding: 10px 20px; font-size: 14px;">Done</button>
            </div>
            <div class="settings-content">
                <div class="setting-item">
                    <label class="setting-label">
                        <input type="checkbox" id="soundEnabledCheckbox" class="setting-checkbox">
                        <span class="setting-text">
                            <strong>Enable sound</strong>
                            <small>Play beeps during countdown and completion chimes</small>
                        </span>
                    </label>
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <input type="checkbox" id="countdownEnabledCheckbox" class="setting-checkbox">
                        <span class="setting-text">
                            <strong>Countdown before timers</strong>
                            <small>3-2-1 countdown before each timed exercise</small>
                        </span>
                    </label>
                </div>
                <div class="setting-item">
                    <label class="setting-label">
                        <input type="checkbox" id="autoAdvanceEnabledCheckbox" class="setting-checkbox">
                        <span class="setting-text">
                            <strong>Auto-advance timed exercises</strong>
                            <small>Automatically move to next exercise when timer completes</small>
                        </span>
                    </label>
                </div>
                <div class="settings-tip">
                    <strong>💡 Tip: Keyboard shortcuts</strong>
                    <div class="settings-tip-content">
                        <kbd>←</kbd> <kbd>→</kbd> to navigate • <kbd>Space</kbd> to start/pause
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <button class="timeline-toggle" id="timelineToggle" title="Show routine timeline">📋</button>
        <button class="sound-toggle" id="settingsToggle" title="Settings">⚙️</button>

        <div id="exerciseView">
            <div class="header">
                <h1 id="routineTitle">🧩 Foot-Ankle-Calf Routine</h1>
                <p id="routineSubtitle">25-30 minutes • 4-5× per week</p>
            </div>

            <div class="progress-container">
                <div class="progress-text">
                    <span id="progressText">Exercise 1 of 32</span>
                    <span id="sectionName">Warm-Up</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="exercise-card">
                <span class="section-badge" id="sectionBadge">WARM-UP</span>
                <h2 class="exercise-title" id="exerciseTitle">Ankle Circles</h2>
                <div class="set-info" id="setInfo">Set 1 of 2</div>

                <div id="timerContainer" class="timer-display hidden">
                    <div class="timer-label" id="timerLabel">Time</div>
                    <div class="timer-time" id="timerDisplay">0:00 / 0:40</div>
                </div>

                <div id="repsContainer" class="reps-display hidden">
                    <span id="repsDisplay">10 reps each direction</span>
                </div>

                <div class="instructions">
                    <div id="instructionsText"></div>
                    <div id="feelCue" class="feel-cue hidden"></div>
                </div>

                <div class="next-preview" id="nextPreview"></div>
            </div>

            <div class="controls">
                <div class="all-controls">
                    <button class="btn btn-secondary" id="prevBtn" title="Previous">←</button>
                    <button class="btn btn-tertiary" id="resetBtn" title="Reset">🔄</button>
                    <button class="btn btn-tertiary" id="pauseBtn" title="Start/Pause">⏸</button>
                    <button class="btn btn-primary" id="nextBtn" title="Next">→</button>
                </div>
            </div>
        </div>

        <div id="completionView" class="hidden completion-screen">
            <div class="completion-emoji">🎉</div>
            <h2>Routine Complete!</h2>

            <button class="btn btn-primary" id="restartBtn" style="max-width: 300px; margin: 0 auto; margin-top: 30px;">
                🔄 Start New Session
            </button>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Confirmation modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-dialog">
            <button class="modal-close-btn" id="confirmCloseBtnX" title="Close">×</button>
            <div class="confirm-title" id="confirmTitle">Confirm Action</div>
            <div class="confirm-message" id="confirmMessage">Are you sure?</div>
            <div class="confirm-actions">
                <button class="btn btn-secondary" id="confirmCancelBtn" style="padding: 12px 24px;">Cancel</button>
                <button class="btn btn-primary" id="confirmOkBtn" style="padding: 12px 24px;">OK</button>
            </div>
        </div>
    </div>

    <!-- Info modal -->
    <div class="info-modal" id="infoModal">
        <div class="info-dialog">
            <button class="modal-close-btn" id="infoCloseBtnX" title="Close">×</button>
            <div class="info-title" id="infoTitle">Information</div>
            <div class="info-message" id="infoMessage"></div>
            <div class="info-actions">
                <button class="btn btn-primary" id="infoOkBtn" style="padding: 12px 24px;">Got it!</button>
            </div>
        </div>
    </div>

    <script>
        // Load configuration from YAML
        let routine = [];
        let exercises = [];
        let config = null;
        let originalYamlText = '';  // Store original YAML for reset functionality
        let currentYamlText = '';   // Store current YAML (may be edited)

        const CUSTOM_CONFIG_KEY = 'ankleRoutineCustomConfig';

        async function loadConfig() {
            try {
                let yamlText = '';

                // Priority 1: Check for URL data parameter
                const params = new URLSearchParams(location.search);
                const encoded = params.get('data');
                if (encoded) {
                    const decodedYAML = decodeYAMLfromURL(encoded);
                    if (decodedYAML) {
                        yamlText = decodedYAML;
                        console.log('Loaded configuration from URL');
                        // Save to localStorage so it persists
                        localStorage.setItem(CUSTOM_CONFIG_KEY, yamlText);
                    } else {
                        alert('⚠️ Could not decode routine from URL. Loading from localStorage or default routine instead.');
                    }
                }

                // Priority 2: Check if there's a custom config in localStorage
                if (!yamlText) {
                    const customConfig = localStorage.getItem(CUSTOM_CONFIG_KEY);
                    if (customConfig) {
                        // Use custom config from localStorage
                        yamlText = customConfig;
                        console.log('Loaded custom configuration from localStorage');
                    }
                }

                // Priority 3: Load original config from file
                if (!yamlText) {
                    const response = await fetch('routine.yml');
                    yamlText = await response.text();
                    console.log('Loaded original configuration from routine.yml');
                }

                // Store both original and current YAML
                if (!originalYamlText) {
                    // Only fetch original once
                    const response = await fetch('routine.yml');
                    originalYamlText = await response.text();
                }
                currentYamlText = yamlText;

                // Parse YAML
                config = jsyaml.load(yamlText);

                // Set title and subtitle
                document.title = config.title;
                document.getElementById('routineTitle').textContent = config.title;
                document.getElementById('routineSubtitle').textContent = config.subtitle;

                // Load exercises
                routine = config.exercises;

                // Clear existing exercises
                exercises = [];

                // Expand exercises into individual sets (only for timed and rest exercises)
                routine.forEach(ex => {
                    if (ex.type === 'timed' || ex.type === 'rest') {
                        // Timed and rest exercises get separate cards for each set
                        for (let set = 1; set <= ex.sets; set++) {
                            exercises.push({
                                ...ex,
                                currentSet: set
                            });
                        }
                    } else {
                        // Rep exercises get a single card with set info in description
                        exercises.push({
                            ...ex,
                            currentSet: 1,
                            displayReps: ex.sets > 1 ? `${ex.sets} sets of ${ex.reps}` : ex.reps
                        });
                    }
                });

                return true;
            } catch (error) {
                console.error('Error loading routine configuration:', error);
                alert('Failed to load routine configuration: ' + error.message);
                return false;
            }
        }

        function saveCustomConfig(yamlText) {
            try {
                // Validate YAML before saving
                jsyaml.load(yamlText);
                localStorage.setItem(CUSTOM_CONFIG_KEY, yamlText);
                return true;
            } catch (error) {
                alert('Invalid YAML configuration: ' + error.message);
                return false;
            }
        }

        function resetToOriginalConfig() {
            localStorage.removeItem(CUSTOM_CONFIG_KEY);
            currentYamlText = originalYamlText;
        }

        function hasCustomConfig() {
            return localStorage.getItem(CUSTOM_CONFIG_KEY) !== null;
        }

        // --- YAML Compression & Sharing Logic ---

        function encodeYAMLtoURL(yamlText) {
            const compressed = pako.gzip(yamlText);
            // Convert to base64 and make URL-safe
            const base64 = btoa(String.fromCharCode.apply(null, compressed));
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        function decodeYAMLfromURL(encoded) {
            try {
                // Convert URL-safe base64 back to regular base64
                let base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
                // Add padding if needed
                while (base64.length % 4) {
                    base64 += '=';
                }
                // Decode base64 to binary
                const binaryString = atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return pako.ungzip(bytes, { to: 'string' });
            } catch (e) {
                console.error('Failed to decode YAML from URL:', e);
                return null;
            }
        }

        function shareConfig() {
            const encoded = encodeYAMLtoURL(currentYamlText);
            const url = `${location.origin}${location.pathname}?data=${encoded}`;
            navigator.clipboard.writeText(url);
            showToast('✅ Shareable link copied to clipboard!');
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function showConfirm(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const titleEl = document.getElementById('confirmTitle');
                const messageEl = document.getElementById('confirmMessage');
                const okBtn = document.getElementById('confirmOkBtn');
                const cancelBtn = document.getElementById('confirmCancelBtn');

                titleEl.textContent = title;
                messageEl.textContent = message;
                modal.classList.add('show');

                const handleOk = () => {
                    modal.classList.remove('show');
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    modal.removeEventListener('click', handleBackdrop);
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.classList.remove('show');
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    modal.removeEventListener('click', handleBackdrop);
                    resolve(false);
                };

                const handleBackdrop = (e) => {
                    if (e.target === modal) {
                        handleCancel();
                    }
                };

                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
                modal.addEventListener('click', handleBackdrop);
            });
        }

        function showInfo(title, messageHtml) {
            const modal = document.getElementById('infoModal');
            const titleEl = document.getElementById('infoTitle');
            const messageEl = document.getElementById('infoMessage');
            const okBtn = document.getElementById('infoOkBtn');
            const closeBtnX = document.getElementById('infoCloseBtnX');

            titleEl.textContent = title;
            messageEl.innerHTML = messageHtml;
            modal.classList.add('show');

            const handleClose = () => {
                modal.classList.remove('show');
                okBtn.removeEventListener('click', handleClose);
                closeBtnX.removeEventListener('click', handleClose);
                modal.removeEventListener('click', handleBackdrop);
            };

            const handleBackdrop = (e) => {
                if (e.target === modal) {
                    handleClose();
                }
            };

            okBtn.addEventListener('click', handleClose);
            closeBtnX.addEventListener('click', handleClose);
            modal.addEventListener('click', handleBackdrop);
        }

        // State
        let currentIndex = 0;
        let timerInterval = null;
        let elapsedSeconds = 0;
        let isPaused = false;
        let timerStarted = false;
        let currentDuration = 0;
        let soundEnabled = localStorage.getItem('soundEnabled') === 'true';
        let countdownEnabled = localStorage.getItem('countdownEnabled') === 'true';
        let autoAdvanceEnabled = localStorage.getItem('autoAdvanceEnabled') === 'true';
        let sessionStartTime = Date.now();

        // Elements
        const progressText = document.getElementById('progressText');
        const sectionName = document.getElementById('sectionName');
        const progressFill = document.getElementById('progressFill');
        const sectionBadge = document.getElementById('sectionBadge');
        const exerciseTitle = document.getElementById('exerciseTitle');
        const setInfo = document.getElementById('setInfo');
        const timerContainer = document.getElementById('timerContainer');
        const timerLabel = document.getElementById('timerLabel');
        const timerDisplay = document.getElementById('timerDisplay');
        const repsContainer = document.getElementById('repsContainer');
        const repsDisplay = document.getElementById('repsDisplay');
        const instructionsText = document.getElementById('instructionsText');
        const feelCue = document.getElementById('feelCue');
        const nextPreview = document.getElementById('nextPreview');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const settingsToggle = document.getElementById('settingsToggle');
        const exerciseView = document.getElementById('exerciseView');
        const completionView = document.getElementById('completionView');
        const restartBtn = document.getElementById('restartBtn');
        const timelineToggle = document.getElementById('timelineToggle');
        const timelinePanel = document.getElementById('timelinePanel');
        const timelineOverlay = document.getElementById('timelineOverlay');
        const timelineContent = document.getElementById('timelineContent');
        const shareConfigBtn = document.getElementById('shareConfigBtn');
        const editConfigBtn = document.getElementById('editConfigBtn');
        const resetConfigBtn = document.getElementById('resetConfigBtn');
        const editorModal = document.getElementById('editorModal');
        const editorTextarea = document.getElementById('editorTextarea');
        const editorSaveBtn = document.getElementById('editorSaveBtn');
        const settingsModal = document.getElementById('settingsModal');
        const settingsCloseBtn = document.getElementById('settingsCloseBtn');
        const soundEnabledCheckbox = document.getElementById('soundEnabledCheckbox');
        const countdownEnabledCheckbox = document.getElementById('countdownEnabledCheckbox');
        const autoAdvanceEnabledCheckbox = document.getElementById('autoAdvanceEnabledCheckbox');

        // Audio context for generating sounds
        let audioContext = null;

        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        // Build timeline from exercises
        function buildTimeline() {
            const sections = {};

            // Group exercises by section
            exercises.forEach((ex, index) => {
                if (!sections[ex.section]) {
                    sections[ex.section] = [];
                }
                sections[ex.section].push({ ...ex, index });
            });

            // Build HTML
            let html = '';
            for (const [sectionName, sectionExercises] of Object.entries(sections)) {
                html += `<div class="timeline-section">`;
                html += `<div class="timeline-section-title">${sectionName}</div>`;

                sectionExercises.forEach(ex => {
                    let meta = '';
                    if (ex.type === 'timed' || ex.type === 'rest') {
                        meta = `${ex.duration}s${ex.sets > 1 ? ` • Set ${ex.currentSet}/${ex.sets}` : ''}`;
                    } else {
                        meta = ex.displayReps || ex.reps;
                    }

                    const restClass = ex.type === 'rest' ? ' rest' : '';

                    html += `
                        <div class="timeline-exercise${restClass}" data-index="${ex.index}">
                            <div>${ex.name}</div>
                            <div class="timeline-exercise-meta">${meta}</div>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            timelineContent.innerHTML = html;

            // Add click handlers
            document.querySelectorAll('.timeline-exercise').forEach(el => {
                el.addEventListener('click', () => {
                    const index = parseInt(el.getAttribute('data-index'));
                    jumpToExercise(index);
                });
            });

            updateTimelineHighlight();
        }

        function updateTimelineHighlight() {
            document.querySelectorAll('.timeline-exercise').forEach(el => {
                const index = parseInt(el.getAttribute('data-index'));
                el.classList.remove('current', 'completed');

                if (index === currentIndex) {
                    el.classList.add('current');
                } else if (index < currentIndex) {
                    el.classList.add('completed');
                }
            });
        }

        function jumpToExercise(index) {
            // Stop and reset any running timer
            stopTimer();
            timerStarted = false;
            isPaused = false;
            elapsedSeconds = 0;

            currentIndex = index;
            renderExercise();
            updateTimelineHighlight();
        }

        function toggleTimeline() {
            const isOpen = timelinePanel.classList.contains('open');
            if (isOpen) {
                closeTimeline();
            } else {
                openTimeline();
            }
        }

        function openTimeline() {
            timelinePanel.classList.add('open');
            timelineOverlay.classList.add('visible');
            updateTimelineHighlight();
        }

        function closeTimeline() {
            timelinePanel.classList.remove('open');
            timelineOverlay.classList.remove('visible');
        }

        // Configuration editor functions
        function openEditor() {
            editorTextarea.value = currentYamlText;
            editorModal.classList.add('open');
            closeTimeline();  // Close timeline when opening editor
        }

        function closeEditor() {
            editorModal.classList.remove('open');
        }

        async function saveEditorChanges() {
            const yamlText = editorTextarea.value;
            if (saveCustomConfig(yamlText)) {
                currentYamlText = yamlText; // Update current YAML for sharing
                // Keep editor open so user can share after saving
                // Reload configuration
                await loadConfig();
                // Rebuild UI
                currentIndex = 0;
                buildTimeline();
                renderExercise();
                showToast('✅ Changes saved successfully!');
            }
        }

        async function resetConfig() {
            const confirmed = await showConfirm(
                'Reset Configuration',
                'Reset to original configuration? Your custom changes will be lost.'
            );

            if (confirmed) {
                resetToOriginalConfig();
                await loadConfig();
                currentIndex = 0;
                buildTimeline();
                renderExercise();
                // Update editor textarea to show the reset configuration
                editorTextarea.value = currentYamlText;
                showToast('↺ Configuration reset to original');
            }
        }

        function copyRoutinePrompt() {
            const promptWithYaml = `Can you create a YAML file for a workout routine with [describe your workout here - e.g., "3 sets of 20 push-ups, 3 sets of 15 squats with 24kg kettlebell, 1 minute plank, and 1 minute side plank on each side"]?

The YAML should have this exact structure:

\`\`\`yaml
title: "Workout Name"
subtitle: "Duration • Frequency"
exercises:
  - section: "Warm-Up"
    name: "Exercise Name"
    type: "reps"
    sets: 2
    reps: "10 reps"
    instructions: "How to perform the exercise"
    feel: null

  - section: "Warm-Up"
    name: "Rest"
    type: "rest"
    duration: 30
    sets: 1

  - section: "Main Workout"
    name: "Timed Exercise"
    type: "timed"
    sets: 3
    duration: 45
    instructions: "Hold this position"
    feel: "Core engagement"
\`\`\`

Critical rules:
- title and subtitle are NOT list items (no dash before them)
- Each exercise under exercises: IS a list item (dash before section:)
- Type must be exactly "reps", "timed", or "rest" (in quotes)
- For "reps" exercises: include sets, reps, instructions, feel (optional)
- For "timed" exercises: include sets, duration (seconds), instructions, feel (optional)
- For "rest" exercises: ONLY include type: "rest", duration (seconds), sets: 1, and optionally name: "Rest"
  * Rest exercises are used BETWEEN other exercises as recovery periods
  * Do NOT include reps, instructions, or feel for rest exercises
- Each timed/rest exercise with sets > 1 will create multiple cards (one per set)
- Each reps exercise shows all sets on one card

Please output only the YAML file in a code block.`;

            navigator.clipboard.writeText(promptWithYaml);
            const btn = document.getElementById('routinePromptCopyBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = originalText, 1000);
        }

        function showRoutineInfo() {
            const messageHtml = `
                <p>The easiest way to create your own routine:</p>
                <ol>
                    <li>Click "Copy" below to copy a ready-to-use prompt</li>
                    <li>Paste it into ChatGPT, Claude, or any AI assistant</li>
                    <li>Replace the bracketed text with your own workout description</li>
                    <li>Copy the YAML file it generates and paste it back here in this editor!</li>
                </ol>
                <p><strong>Copy this prompt:</strong></p>
                <div class="info-code-block">
                    <button class="info-code-copy-btn" id="routinePromptCopyBtn">Copy</button>
                    <code>Can you create a YAML file for a workout routine with [describe your workout here]?

The YAML should have this structure:
[Full specification included when you copy]

Please output only the YAML file in a code block.</code>
                </div>
                <p>That's it! The AI handles all the formatting for you.</p>
            `;

            showInfo('Create Your Own Routine', messageHtml);

            // Attach event listener after modal is shown
            setTimeout(() => {
                document.getElementById('routinePromptCopyBtn').addEventListener('click', copyRoutinePrompt);
            }, 0);
        }

        // Initialize
        async function init() {
            // Load configuration first
            const loaded = await loadConfig();
            if (!loaded) return;

            buildTimeline();
            renderExercise();

            nextBtn.addEventListener('click', nextExercise);
            prevBtn.addEventListener('click', previousExercise);
            pauseBtn.addEventListener('click', togglePause);
            resetBtn.addEventListener('click', resetTimer);
            settingsToggle.addEventListener('click', openSettings);
            restartBtn.addEventListener('click', restart);
            timelineToggle.addEventListener('click', toggleTimeline);
            timelineOverlay.addEventListener('click', closeTimeline);

            // Editor event listeners
            shareConfigBtn.addEventListener('click', shareConfig);
            editConfigBtn.addEventListener('click', openEditor);
            resetConfigBtn.addEventListener('click', resetConfig);
            editorSaveBtn.addEventListener('click', saveEditorChanges);
            document.getElementById('editorCloseBtn').addEventListener('click', closeEditor);
            document.getElementById('routineInfoBtn').addEventListener('click', showRoutineInfo);
            editorModal.addEventListener('click', (e) => {
                if (e.target === editorModal) closeEditor();
            });

            // Settings event listeners
            settingsCloseBtn.addEventListener('click', closeSettings);
            document.getElementById('settingsCloseBtnX').addEventListener('click', closeSettings);
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) closeSettings();
            });
            soundEnabledCheckbox.addEventListener('change', updateSettings);
            countdownEnabledCheckbox.addEventListener('change', updateSettings);
            autoAdvanceEnabledCheckbox.addEventListener('change', updateSettings);

            // Confirmation modal close button
            document.getElementById('confirmCloseBtnX').addEventListener('click', () => {
                document.getElementById('confirmCancelBtn').click();
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Disable all keyboard shortcuts when editor is open (except Escape)
                const editorOpen = editorModal.classList.contains('open');

                // Escape to close modals (check highest z-index first)
                if (e.code === 'Escape') {
                    const infoModal = document.getElementById('infoModal');
                    const confirmModal = document.getElementById('confirmModal');

                    if (infoModal.classList.contains('show')) {
                        // Close info modal first (highest z-index)
                        document.getElementById('infoOkBtn').click();
                    } else if (confirmModal.classList.contains('show')) {
                        // Trigger cancel on confirmation modal
                        document.getElementById('confirmCancelBtn').click();
                    } else if (settingsModal.classList.contains('open')) {
                        closeSettings();
                    } else if (editorModal.classList.contains('open')) {
                        closeEditor();
                    } else if (timelinePanel.classList.contains('open')) {
                        closeTimeline();
                    }
                    return;
                }

                // Skip other shortcuts if editor is open
                if (editorOpen) return;

                // Spacebar to start/pause timer
                const currentEx = exercises[currentIndex];
                if (e.code === 'Space' && (currentEx.type === 'timed' || currentEx.type === 'rest')) {
                    e.preventDefault(); // Prevent page scroll
                    togglePause();
                }
                // Arrow keys for navigation
                else if (e.code === 'ArrowRight') {
                    e.preventDefault();
                    nextExercise();
                }
                else if (e.code === 'ArrowLeft') {
                    e.preventDefault();
                    previousExercise();
                }
            });
        }

        function renderExercise() {
            const ex = exercises[currentIndex];
            const isRest = ex.type === 'rest';

            // Update progress
            progressText.textContent = `Exercise ${currentIndex + 1} of ${exercises.length}`;
            sectionName.textContent = ex.section;
            progressFill.style.width = `${((currentIndex + 1) / exercises.length) * 100}%`;

            // Update exercise info
            sectionBadge.textContent = ex.section.toUpperCase();
            exerciseTitle.textContent = ex.name;
            // Only show set info for timed exercises (not rest)
            setInfo.textContent = (ex.type === 'timed' && ex.sets > 1) ? `Set ${ex.currentSet} of ${ex.sets}` : '';

            // Apply rest styling to exercise card
            const exerciseCard = document.querySelector('.exercise-card');
            if (isRest) {
                exerciseCard.classList.add('rest');
            } else {
                exerciseCard.classList.remove('rest');
            }

            // Instructions (simplified for rest)
            if (isRest) {
                instructionsText.innerHTML = `<p>Take a break and prepare for the next exercise.</p>`;
                feelCue.classList.add('hidden');
            } else {
                instructionsText.innerHTML = `<p>${ex.instructions}</p>`;
                if (ex.feel) {
                    feelCue.textContent = `👉 Feel: ${ex.feel}`;
                    feelCue.classList.remove('hidden');
                } else {
                    feelCue.classList.add('hidden');
                }
            }

            // Timer or reps
            if (ex.type === 'timed' || isRest) {
                timerContainer.classList.remove('hidden');
                repsContainer.classList.add('hidden');
                pauseBtn.style.display = 'block';
                resetBtn.style.display = 'block';

                // Apply rest styling to timer and set label
                if (isRest) {
                    timerContainer.classList.add('rest');
                    timerLabel.textContent = 'Rest';
                } else {
                    timerContainer.classList.remove('rest');
                    timerLabel.textContent = ex.duration >= 60 ? 'Hold Time' : 'Time';
                }

                // Initialize timer but don't start it
                currentDuration = ex.duration;
                elapsedSeconds = 0;
                timerStarted = false;
                isPaused = false;
                updateTimerDisplay(ex.duration);
                pauseBtn.textContent = '▶';
            } else {
                timerContainer.classList.add('hidden');
                timerContainer.classList.remove('rest');
                repsContainer.classList.remove('hidden');
                pauseBtn.style.display = 'none';
                resetBtn.style.display = 'none';
                repsDisplay.textContent = ex.displayReps || ex.reps;
                stopTimer();
            }

            // Enable/disable Previous button
            prevBtn.disabled = currentIndex === 0;
            prevBtn.style.opacity = currentIndex === 0 ? '0.5' : '1';
            prevBtn.style.cursor = currentIndex === 0 ? 'not-allowed' : 'pointer';

            // Next preview
            if (currentIndex < exercises.length - 1) {
                const next = exercises[currentIndex + 1];
                nextPreview.innerHTML = `<strong>UP NEXT:</strong> ${next.name} <span style="color: #999; font-size: 13px;">• ${next.section}</span>`;
                nextPreview.classList.remove('hidden');
            } else {
                nextPreview.classList.add('hidden');
            }
        }

        function startTimer(duration, skipCountdown = false) {
            stopTimer();

            const ex = exercises[currentIndex];
            const isRest = ex.type === 'rest';

            // Skip countdown for rest exercises or when explicitly requested
            if (countdownEnabled && !isRest && !skipCountdown) {
                // Start with 3-2-1 countdown
                startCountdown(duration);
            } else {
                // Start timer immediately
                startMainTimer(duration);
            }
        }

        function startCountdown(duration) {
            let countdownSeconds = 3;
            timerDisplay.textContent = '3';

            // C major chord arpeggio: C, E, G, then quick arpeggio for GO
            // Play first note (C) immediately
            playBeep(523.25, 0.15);  // C5

            timerInterval = setInterval(() => {
                if (!isPaused) {
                    countdownSeconds--;

                    if (countdownSeconds === 2) {
                        timerDisplay.textContent = '2';
                        playBeep(659.25, 0.15);  // E5
                    } else if (countdownSeconds === 1) {
                        timerDisplay.textContent = '1';
                        playBeep(783.99, 0.15);  // G5
                    } else if (countdownSeconds === 0) {
                        // Play quick arpeggio for "GO"
                        playArpeggio();
                        // Countdown complete, start main timer
                        stopTimer();
                        startMainTimer(duration);
                    }
                }
            }, 1000);
        }

        function startMainTimer(duration) {
            elapsedSeconds = 0;
            updateTimerDisplay(duration);

            timerInterval = setInterval(() => {
                if (!isPaused) {
                    elapsedSeconds++;
                    updateTimerDisplay(duration);

                    const remaining = duration - elapsedSeconds;

                    // Play C Mixolydian countdown sounds at 3, 2, 1 (descending, leading to completion arpeggio)
                    if (remaining === 3) {
                        playBeep(932.33, 0.15);  // Bb5
                    } else if (remaining === 2) {
                        playBeep(659.25, 0.15);  // E5
                    } else if (remaining === 1) {
                        playBeep(523.25, 0.15);  // C5
                    } else if (remaining === 0) {
                        stopTimer();
                        playCompletionSound();  // C6, Bb5, E5, C5 Mixolydian descending arpeggio

                        // Auto-advance if enabled and current exercise is timed or rest
                        const ex = exercises[currentIndex];
                        if (autoAdvanceEnabled && (ex.type === 'timed' || ex.type === 'rest')) {
                            // Wait 1 second before advancing
                            setTimeout(() => {
                                nextExercise();
                            }, 1000);
                        }
                    }
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay(duration) {
            const elapsed = formatTime(elapsedSeconds);
            const total = formatTime(duration);
            timerDisplay.textContent = `${elapsed} / ${total}`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function togglePause() {
            if (!timerStarted) {
                // Start the timer for the first time
                timerStarted = true;
                startTimer(currentDuration);
                pauseBtn.textContent = '⏸';
            } else {
                // Toggle pause state
                isPaused = !isPaused;
                pauseBtn.textContent = isPaused ? '▶' : '⏸';
            }
        }

        function resetTimer() {
            const ex = exercises[currentIndex];
            if (ex.type === 'timed') {
                stopTimer();
                timerStarted = false;
                isPaused = false;
                elapsedSeconds = 0;
                updateTimerDisplay(ex.duration);
                pauseBtn.textContent = '▶';
            }
        }

        function nextExercise() {
            // Stop and reset any running timer
            stopTimer();
            timerStarted = false;
            isPaused = false;
            elapsedSeconds = 0;

            currentIndex++;

            if (currentIndex >= exercises.length) {
                showCompletion();
            } else {
                renderExercise();
                updateTimelineHighlight();

                // Auto-start timer if auto-advance is enabled and next exercise is timed/rest
                const nextEx = exercises[currentIndex];
                if (autoAdvanceEnabled && (nextEx.type === 'timed' || nextEx.type === 'rest')) {
                    timerStarted = true;
                    // Include countdown during auto-advance for consistency
                    startTimer(nextEx.duration, false);
                    pauseBtn.textContent = '⏸';
                }
            }
        }

        function previousExercise() {
            if (currentIndex > 0) {
                // Stop and reset any running timer
                stopTimer();
                timerStarted = false;
                isPaused = false;
                elapsedSeconds = 0;

                currentIndex--;
                renderExercise();
                updateTimelineHighlight();
            }
        }

        function showCompletion() {
            stopTimer();
            exerciseView.classList.add('hidden');
            completionView.classList.remove('hidden');
            playRoutineCompleteJingle();
        }

        function restart() {
            currentIndex = 0;
            sessionStartTime = Date.now();
            exerciseView.classList.remove('hidden');
            completionView.classList.add('hidden');
            renderExercise();
            updateTimelineHighlight();
        }

        function openSettings() {
            // Set checkbox states from current settings
            soundEnabledCheckbox.checked = soundEnabled;
            countdownEnabledCheckbox.checked = countdownEnabled;
            autoAdvanceEnabledCheckbox.checked = autoAdvanceEnabled;
            settingsModal.classList.add('open');
        }

        function closeSettings() {
            settingsModal.classList.remove('open');
        }

        function updateSettings() {
            // Save settings when checkboxes change
            soundEnabled = soundEnabledCheckbox.checked;
            countdownEnabled = countdownEnabledCheckbox.checked;
            autoAdvanceEnabled = autoAdvanceEnabledCheckbox.checked;
            localStorage.setItem('soundEnabled', soundEnabled);
            localStorage.setItem('countdownEnabled', countdownEnabled);
            localStorage.setItem('autoAdvanceEnabled', autoAdvanceEnabled);
        }

        // Play a simple beep at a given frequency
        function playBeep(frequency, duration) {
            if (!soundEnabled) return;

            try {
                const ctx = getAudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + duration);
            } catch (e) {
                console.log('Audio play failed:', e);
            }
        }

        // Play an arpeggiating major chord for "GO" signal
        function playArpeggio() {
            if (!soundEnabled) return;

            try {
                const ctx = getAudioContext();
                // C major arpeggio: C5, E5, G5, C6 (bright, energizing "get ready to GO!")
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                const startTime = ctx.currentTime;

                notes.forEach((freq, index) => {
                    const oscillator = ctx.createOscillator();
                    const gainNode = ctx.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);

                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';

                    const noteStart = startTime + (index * 0.06); // Quick arpeggio
                    const noteDuration = 0.3;

                    gainNode.gain.setValueAtTime(0, noteStart);
                    gainNode.gain.linearRampToValueAtTime(0.25, noteStart + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, noteStart + noteDuration);

                    oscillator.start(noteStart);
                    oscillator.stop(noteStart + noteDuration);
                });
            } catch (e) {
                console.log('Audio play failed:', e);
            }
        }

        // Play a nice completion sound (Mixolydian mode - "well done" with satisfying resolution)
        function playCompletionSound() {
            if (!soundEnabled) return;

            try {
                const ctx = getAudioContext();

                // C Mixolydian descending arpeggio: C6, Bb5, E5, C5 (winding down, bluesy "bringing it home" feel)
                const notes = [1046.50, 932.33, 659.25, 523.25]; // C6, Bb5, E5, C5
                const startTime = ctx.currentTime;

                notes.forEach((freq, index) => {
                    const oscillator = ctx.createOscillator();
                    const gainNode = ctx.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);

                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';

                    const noteStart = startTime + (index * 0.06); // Quick arpeggio (same speed as startup)
                    const noteDuration = 0.3;

                    gainNode.gain.setValueAtTime(0, noteStart);
                    gainNode.gain.linearRampToValueAtTime(0.3, noteStart + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, noteStart + noteDuration);

                    oscillator.start(noteStart);
                    oscillator.stop(noteStart + noteDuration);
                });
            } catch (e) {
                console.log('Audio play failed:', e);
            }
        }

        // Play a unique celebratory jingle when entire routine completes
        function playRoutineCompleteJingle() {
            if (!soundEnabled) return;

            try {
                const ctx = getAudioContext();

                // Extended C major pentatonic across 2 octaves for variety
                const pentatonicScale = [
                    261.63, 293.66, 329.63, 392.00, 440.00,  // C4, D4, E4, G4, A4
                    523.25, 587.33, 659.25, 783.99, 880.00,  // C5, D5, E5, G5, A5
                    1046.50, 1174.66                          // C6, D6
                ];

                const numEvents = 5 + Math.floor(Math.random() * 4); // 5-8 musical events
                let currentTime = ctx.currentTime;

                for (let i = 0; i < numEvents; i++) {
                    // Randomly decide if this is a single note or chord (30% chance of chord)
                    const isChord = Math.random() < 0.3 && i > 0; // No chord on first note
                    const numNotes = isChord ? (Math.random() < 0.5 ? 2 : 3) : 1;

                    // Random note duration: short (0.15s), medium (0.3s), or long (0.5s)
                    const durationChoices = [0.15, 0.3, 0.5];
                    const noteDuration = durationChoices[Math.floor(Math.random() * durationChoices.length)];

                    // Last note should be long and resolve to C
                    const isLastEvent = i === numEvents - 1;

                    for (let n = 0; n < numNotes; n++) {
                        let noteIndex;

                        if (isLastEvent && n === 0) {
                            // End on high C for resolution
                            noteIndex = 10; // C6
                        } else if (isChord) {
                            // For chords, use intervals that sound good (thirds and fifths)
                            noteIndex = 5 + (n * 2); // Create pleasant intervals
                        } else {
                            // Random note with bias toward middle-high range
                            noteIndex = 4 + Math.floor(Math.random() * 6); // Favor C5-C6 range
                        }

                        const freq = pentatonicScale[Math.min(noteIndex, pentatonicScale.length - 1)];
                        const oscillator = ctx.createOscillator();
                        const gainNode = ctx.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(ctx.destination);

                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';

                        // Louder for final note
                        const volume = isLastEvent ? 0.35 : 0.2 + Math.random() * 0.1;

                        gainNode.gain.setValueAtTime(0, currentTime);
                        gainNode.gain.linearRampToValueAtTime(volume, currentTime + 0.01);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, currentTime + noteDuration);

                        oscillator.start(currentTime);
                        oscillator.stop(currentTime + noteDuration);
                    }

                    // Varied spacing: short (0.08s), medium (0.15s), or long (0.25s)
                    const spacingChoices = [0.08, 0.15, 0.25];
                    const spacing = spacingChoices[Math.floor(Math.random() * spacingChoices.length)];

                    currentTime += noteDuration + spacing;
                }
            } catch (e) {
                console.log('Audio play failed:', e);
            }
        }

        // Start
        init();
    </script>
</body>
</html>
